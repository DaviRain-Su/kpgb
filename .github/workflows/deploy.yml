name: Deploy to GitHub Pages

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # 允许手动触发

# 设置 GITHUB_TOKEN 的权限
permissions:
  contents: read
  pages: write
  id-token: write

# 只允许一个并发部署
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # 构建任务
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          
      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          
      - name: Create production config
        run: |
          cat > site.production.toml << EOL
          title = "My IPFS Blog"
          description = "A decentralized blog powered by IPFS"
          author = "Your Name"
          base_url = "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          ipfs_gateway = "https://ipfs.io/ipfs/"
          posts_per_page = 10
          enable_rss = true
          enable_search = true
          theme = "default"
          EOL
          
      - name: Build project
        run: cargo build --release
        
      - name: Generate static site
        run: |
          # 备份配置
          cp site.toml site.toml.backup || true
          # 使用生产配置
          cp site.production.toml site.toml
          # 生成静态网站
          cargo run -- generate
          # 恢复配置
          mv site.toml.backup site.toml || true
          
      - name: Add .nojekyll
        run: touch public/.nojekyll
        
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  # 部署任务
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4