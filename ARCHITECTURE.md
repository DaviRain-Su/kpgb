# KPGB 系统架构与愿景

## 系统概述

KPGB 是一个基于 IPFS 的去中心化博客系统，设计理念是：
- **内容永久性**：所有内容存储在 IPFS 上，永不丢失
- **索引本地化**：每个用户维护自己的索引，快速访问
- **部署灵活性**：支持静态网站和动态服务器两种模式

## 核心架构

```
┌─────────────────────────────────────────────────────────────┐
│                        用户内容层                             │
├─────────────────────────────────────────────────────────────┤
│  内容创作 → SHA256去重 → IPFS存储 → 获得CID → 本地索引更新    │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                        存储层 (IPFS)                         │
├─────────────────────────────────────────────────────────────┤
│  • 内容永久保存                                               │
│  • 通过 CID 全球访问                                          │
│  • 去中心化分布式存储                                         │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                        索引层 (SQLite)                       │
├─────────────────────────────────────────────────────────────┤
│  • 文章元数据（标题、作者、时间、标签）                         │
│  • 全文搜索索引 (FTS5)                                       │
│  • CID 映射关系                                              │
│  • 发布状态管理                                              │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                        展示层（两种模式）                      │
├─────────────────────────────────────────────────────────────┤
│  静态网站模式                    │  动态服务器模式              │
│  • GitHub Pages               │  • 本地/云服务器              │
│  • Netlify/Vercel             │  • 实时API                   │
│  • 任意静态托管                 │  • 动态搜索                   │
│  • 客户端搜索                   │  • 实时更新                   │
└─────────────────────────────────────────────────────────────┘
```

## 两种部署模式对比

### 1. 静态网站模式
**适用场景**：个人博客、小型团队、低成本托管

**优势**：
- ✅ 零服务器成本（GitHub Pages 免费）
- ✅ 全球 CDN 加速
- ✅ 高可用性
- ✅ 易于部署

**劣势**：
- ❌ 需要重新生成才能更新
- ❌ 搜索功能受限（客户端搜索）
- ❌ 无法实时交互

**部署方式**：
```bash
# GitHub Pages
git push → GitHub Actions → 自动部署

# Netlify/Vercel
拖拽 public 文件夹 → 即刻上线
```

### 2. 动态服务器模式
**适用场景**：团队协作、内容平台、需要实时功能

**优势**：
- ✅ 实时更新内容
- ✅ 强大的服务端搜索
- ✅ RESTful API
- ✅ 可扩展性强

**劣势**：
- ❌ 需要服务器成本
- ❌ 需要维护
- ❌ 单点故障风险

**部署方式**：
```bash
# 本地服务器
cargo run -- serve --port 3000

# 云服务器（Docker）
docker build -t kpgb .
docker run -p 3000:3000 kpgb

# Systemd 服务
sudo systemctl start kpgb
```

## 数据流程

### 发布流程
```
1. 用户创建内容（Markdown）
   ↓
2. 计算内容哈希（SHA256）
   ↓
3. 检查是否重复
   ├─ 是 → 使用已有 CID
   └─ 否 → 上传到 IPFS → 获得新 CID
   ↓
4. 更新本地索引（SQLite）
   ↓
5. 生成展示（静态HTML 或 动态API）
```

### 读取流程
```
1. 用户访问博客
   ↓
2. 查询本地索引
   ↓
3. 获取文章列表和元数据
   ↓
4. 需要完整内容时
   ├─ 本地缓存 → 直接返回
   └─ IPFS → 通过 CID 获取
```

## 索引问题的解决方案

当前每个用户维护自己的索引，这带来了一些挑战：

### 问题
1. **发现困难**：如何找到其他人的内容？
2. **索引同步**：如何保持索引最新？
3. **内容聚合**：如何构建公共内容平台？

### 解决方案

#### 1. 分布式索引协议
```yaml
# 索引共享格式 (index-manifest.json)
{
  "author": "DaviRain-Su",
  "blog_url": "https://davirain-su.github.io/kpgb",
  "index_cid": "QmXXX...",  # 索引文件的 IPFS CID
  "last_updated": "2025-01-21T10:00:00Z",
  "posts_count": 42,
  "topics": ["blockchain", "rust", "ipfs"]
}
```

#### 2. 索引聚合服务
```rust
// 未来功能：索引聚合器
pub struct IndexAggregator {
    // 订阅的博客列表
    subscriptions: Vec<BlogIndex>,
    // 聚合后的内容
    aggregated_posts: Vec<AggregatedPost>,
}

impl IndexAggregator {
    // 定期拉取各博客的索引
    pub async fn sync_indexes(&mut self) -> Result<()> {
        for blog in &self.subscriptions {
            let index = self.fetch_index(&blog.index_cid).await?;
            self.merge_index(index).await?;
        }
        Ok(())
    }
    
    // 搜索所有订阅的博客
    pub async fn search_all(&self, query: &str) -> Vec<SearchResult> {
        // 跨博客搜索实现
    }
}
```

#### 3. 去中心化发现机制
- **IPNS**：可变指针指向最新索引
- **ENS/DNS**：域名指向博客索引
- **DHT**：分布式哈希表存储索引位置
- **社交图谱**：基于关注关系发现内容

## 未来愿景：公共内容聚合平台

### 架构演进
```
个人博客 → 博客联盟 → 内容网络 → 去中心化 Medium
```

### 核心功能
1. **热点聚合**
   - 自动发现热门内容
   - 基于互动数据排序
   - 多维度内容推荐

2. **跨博客搜索**
   - 统一搜索接口
   - 分布式索引
   - 实时结果聚合

3. **内容订阅**
   - RSS/IPNS 订阅
   - 主题订阅
   - 作者订阅

4. **社交功能**
   - 去中心化评论
   - 内容引用
   - 作者互动

### 技术实现路线图

#### Phase 1: 基础设施（当前已完成）
- ✅ IPFS 内容存储
- ✅ 本地索引系统
- ✅ 静态/动态展示

#### Phase 2: 联邦化（进行中）
- [ ] 索引共享协议
- [ ] 跨博客搜索
- [ ] 内容订阅系统

#### Phase 3: 去中心化社交
- [ ] P2P 评论系统
- [ ] 内容推荐算法
- [ ] 代币激励机制

#### Phase 4: 完整平台
- [ ] 移动应用
- [ ] 内容市场
- [ ] DAO 治理

## 部署建议

### 个人用户
1. 使用 GitHub Pages 部署静态版本
2. 内容存储在 IPFS
3. 定期更新索引

### 团队/组织
1. 部署动态服务器
2. 提供 API 服务
3. 实现索引聚合

### 平台运营
1. 多节点部署
2. 索引聚合服务
3. 内容推荐系统

## 技术栈选择理由

- **Rust**: 高性能、内存安全、适合系统编程
- **IPFS**: 去中心化存储、内容寻址、永久保存
- **SQLite**: 轻量级、高性能、支持全文搜索
- **Axum**: 现代异步 Web 框架、高并发
- **Tera**: 灵活的模板引擎、易于定制

## 总结

KPGB 不仅是一个博客系统，更是构建去中心化内容网络的基础设施。通过：
- 内容永久存储在 IPFS
- 本地维护高效索引
- 灵活的部署方式
- 开放的聚合协议

我们正在构建一个真正属于用户的内容平台，where content is permanent, discovery is decentralized, and control remains with creators.