{% extends "base.html" %}

{% block content %}
<!-- Reading Progress Bar -->
<div class="reading-progress" id="reading-progress">
    <div class="progress-bar" id="progress-bar"></div>
</div>

<!-- Font Size Adjuster -->
<div class="font-size-adjuster">
    <button class="font-size-btn" onclick="changeFontSize('decrease')" title="Decrease font size">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="8" y1="11" x2="14" y2="11"></line>
        </svg>
    </button>
    <span class="font-size-value" id="font-size-value">100%</span>
    <button class="font-size-btn" onclick="changeFontSize('increase')" title="Increase font size">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="11" y1="8" x2="11" y2="14"></line>
            <line x1="8" y1="11" x2="14" y2="11"></line>
        </svg>
    </button>
    <button class="font-size-btn" onclick="changeFontSize('reset')" title="Reset font size">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="1 4 1 10 7 10"></polyline>
            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
        </svg>
    </button>
</div>

<!-- Zen Mode Button -->
<button class="zen-mode-btn" onclick="toggleZenMode()" title="Enter Zen Mode">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2L2 7L12 12L22 7L12 2Z"></path>
        <path d="M2 17L12 22L22 17"></path>
        <path d="M2 12L12 17L22 12"></path>
    </svg>
    <span class="zen-mode-text">Zen Mode</span>
</button>

<article class="post">
    <header>
        <h1>{{ post.title }}</h1>
        <div class="post-meta">
            <span class="author">By {{ post.author }}</span>
            <span class="date">{{ post.created_at | date(format="%Y-%m-%d %H:%M") }}</span>
            {% if reading_time %}
            <span class="reading-time">⏱️ {{ reading_time }}</span>
            {% endif %}
            {% if post.category %}
            <span class="category">{{ post.category }}</span>
            {% endif %}
        </div>
        {% if post.tags %}
        <div class="tags">
            {% for tag in post.tags %}
            <a href="{{ site.base_path | default(value="") }}/tags/{{ tag | url_safe_tag }}" class="tag">{{ tag }}</a>
            {% endfor %}
        </div>
        {% endif %}
    </header>

    {% if has_toc %}
    <div class="post-with-toc">
        <aside class="toc-container">
            {{ toc_html | safe }}
        </aside>
        <div class="post-content">
            {{ content_html | safe }}
        </div>
    </div>
    {% else %}
    <div class="post-content">
        {{ content_html | safe }}
    </div>
    {% endif %}

    <footer class="post-footer">
        <div class="post-info">
            <p><strong>Storage ID:</strong> <code>{{ storage_id }}</code></p>
            {% if ipfs_link %}
            <p><strong>IPFS Link:</strong> <a href="{{ ipfs_link }}" target="_blank">View on IPFS</a></p>
            {% endif %}
            <p><strong>Content Hash:</strong> <code>{{ post.content_hash }}</code></p>
        </div>
        <nav class="post-nav">
            <a href="/archive.html">← Back to Archive</a>
        </nav>
    </footer>

    {% if related_posts %}
    <!-- Related Posts -->
    <section class="related-posts">
        <h2>Related Posts</h2>
        <div class="related-posts-grid">
            {% for related in related_posts %}
            <article class="related-post-card">
                <h3><a href="{{ related.url }}">{{ related.title }}</a></h3>
                <div class="post-meta">
                    <span class="date">{{ related.created_at | date(format="%Y-%m-%d") }}</span>
                    {% if related.reading_time %}
                    <span class="reading-time">{{ related.reading_time }}</span>
                    {% endif %}
                </div>
                {% if related.excerpt %}
                    <p class="excerpt">{{ related.excerpt | truncate(length=150) }}</p>
                {% else %}
                    <p class="excerpt">{{ related.content | truncate(length=150) }}</p>
                {% endif %}
                {% if related.tags %}
                <div class="tags-mini">
                    {% for tag in related.tags | slice(end=3) %}
                    <span class="tag-mini">{{ tag }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </article>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {% if site.giscus.enabled and site.giscus.repo_id != "" %}
    <!-- Giscus Comments -->
    <div class="comments">
        <h2>Comments</h2>
        <script src="https://giscus.app/client.js"
                data-repo="{{ site.giscus.repo }}"
                data-repo-id="{{ site.giscus.repo_id }}"
                data-category="{{ site.giscus.category }}"
                data-category-id="{{ site.giscus.category_id }}"
                data-mapping="{{ site.giscus.mapping }}"
                data-strict="0"
                data-reactions-enabled="{% if site.giscus.reactions_enabled %}1{% else %}0{% endif %}"
                data-emit-metadata="{% if site.giscus.emit_metadata %}1{% else %}0{% endif %}"
                data-input-position="{{ site.giscus.input_position }}"
                data-theme="{{ site.giscus.theme }}"
                data-lang="{{ site.giscus.lang }}"
                data-loading="lazy"
                crossorigin="anonymous"
                async>
        </script>
    </div>
    {% endif %}
</article>

{% if has_toc %}
<script>
// TOC active section highlighting
(function() {
    const tocLinks = document.querySelectorAll('.toc-link');
    const headings = document.querySelectorAll('.post-content h1[id], .post-content h2[id], .post-content h3[id], .post-content h4[id], .post-content h5[id], .post-content h6[id]');
    
    if (tocLinks.length === 0 || headings.length === 0) return;
    
    function updateActiveSection() {
        const scrollPosition = window.scrollY + 100; // Offset for better UX
        
        let activeHeading = null;
        for (const heading of headings) {
            if (heading.offsetTop <= scrollPosition) {
                activeHeading = heading;
            } else {
                break;
            }
        }
        
        if (activeHeading) {
            tocLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + activeHeading.id) {
                    link.classList.add('active');
                }
            });
        }
    }
    
    // Update on scroll
    let scrollTimer;
    window.addEventListener('scroll', () => {
        clearTimeout(scrollTimer);
        scrollTimer = setTimeout(updateActiveSection, 50);
    });
    
    // Initial update
    updateActiveSection();
})();
</script>
{% endif %}

<script>
// Reading Progress Bar
(function() {
    const progressBar = document.getElementById('progress-bar');
    const article = document.querySelector('.post');
    
    if (!progressBar || !article) return;
    
    function updateProgressBar() {
        const articleTop = article.offsetTop;
        const articleHeight = article.offsetHeight;
        const windowHeight = window.innerHeight;
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        
        // Add/remove scrolled class
        if (scrollTop > 50) {
            document.body.classList.add('scrolled');
        } else {
            document.body.classList.remove('scrolled');
        }
        
        // Calculate the scrollable area (article height minus viewport height)
        const scrollableArea = articleHeight + articleTop - windowHeight;
        
        // Calculate current scroll position relative to the article
        const currentPosition = scrollTop - articleTop + windowHeight;
        
        // Calculate progress percentage
        let progress = (currentPosition / scrollableArea) * 100;
        
        // Clamp progress between 0 and 100
        progress = Math.max(0, Math.min(100, progress));
        
        // Update progress bar width
        progressBar.style.width = progress + '%';
    }
    
    // Update on scroll
    let scrollTimer;
    window.addEventListener('scroll', () => {
        clearTimeout(scrollTimer);
        scrollTimer = setTimeout(updateProgressBar, 10);
    });
    
    // Update on resize
    window.addEventListener('resize', updateProgressBar);
    
    // Initial update
    updateProgressBar();
})();

// Font Size Adjuster
(function() {
    const MIN_SIZE = 80;
    const MAX_SIZE = 150;
    const STEP = 10;
    const DEFAULT_SIZE = 100;
    
    // Get saved font size from localStorage
    let currentSize = parseInt(localStorage.getItem('postFontSize')) || DEFAULT_SIZE;
    
    // Apply saved font size on load
    applyFontSize(currentSize);
    
    window.changeFontSize = function(action) {
        switch(action) {
            case 'increase':
                currentSize = Math.min(currentSize + STEP, MAX_SIZE);
                break;
            case 'decrease':
                currentSize = Math.max(currentSize - STEP, MIN_SIZE);
                break;
            case 'reset':
                currentSize = DEFAULT_SIZE;
                break;
        }
        
        applyFontSize(currentSize);
        localStorage.setItem('postFontSize', currentSize);
    };
    
    function applyFontSize(size) {
        const postContent = document.querySelector('.post-content');
        const sizeValue = document.getElementById('font-size-value');
        
        if (postContent) {
            postContent.style.fontSize = size + '%';
        }
        
        if (sizeValue) {
            sizeValue.textContent = size + '%';
        }
        
        // Update button states
        document.querySelectorAll('.font-size-btn').forEach(btn => {
            btn.disabled = false;
        });
        
        if (size <= MIN_SIZE) {
            document.querySelector('.font-size-btn[onclick*="decrease"]').disabled = true;
        }
        if (size >= MAX_SIZE) {
            document.querySelector('.font-size-btn[onclick*="increase"]').disabled = true;
        }
    }
})();

// Zen Mode
(function() {
    let isZenMode = false;
    
    window.toggleZenMode = function() {
        isZenMode = !isZenMode;
        const body = document.body;
        const zenBtn = document.querySelector('.zen-mode-btn');
        const zenText = document.querySelector('.zen-mode-text');
        
        if (isZenMode) {
            body.classList.add('zen-mode');
            zenText.textContent = 'Exit Zen';
            zenBtn.setAttribute('title', 'Exit Zen Mode');
            
            // Hide elements for zen mode
            document.querySelector('header')?.classList.add('zen-hidden');
            document.querySelector('footer')?.classList.add('zen-hidden');
            document.querySelector('.post-footer')?.classList.add('zen-hidden');
            document.querySelector('.related-posts')?.classList.add('zen-hidden');
            document.querySelector('.comments')?.classList.add('zen-hidden');
            document.querySelector('.toc-container')?.classList.add('zen-hidden');
            document.querySelector('.font-size-adjuster')?.classList.add('zen-fade');
            
            // Adjust reading progress bar
            document.querySelector('.reading-progress')?.classList.add('zen-minimal');
            
            // Focus on content
            document.querySelector('.post')?.classList.add('zen-focused');
            
            // Add ESC key listener
            document.addEventListener('keydown', handleZenEscape);
        } else {
            exitZenMode();
        }
    };
    
    function exitZenMode() {
        isZenMode = false;
        const body = document.body;
        const zenBtn = document.querySelector('.zen-mode-btn');
        const zenText = document.querySelector('.zen-mode-text');
        
        body.classList.remove('zen-mode');
        zenText.textContent = 'Zen Mode';
        zenBtn.setAttribute('title', 'Enter Zen Mode');
        
        // Show elements
        document.querySelector('header')?.classList.remove('zen-hidden');
        document.querySelector('footer')?.classList.remove('zen-hidden');
        document.querySelector('.post-footer')?.classList.remove('zen-hidden');
        document.querySelector('.related-posts')?.classList.remove('zen-hidden');
        document.querySelector('.comments')?.classList.remove('zen-hidden');
        document.querySelector('.toc-container')?.classList.remove('zen-hidden');
        document.querySelector('.font-size-adjuster')?.classList.remove('zen-fade');
        document.querySelector('.reading-progress')?.classList.remove('zen-minimal');
        document.querySelector('.post')?.classList.remove('zen-focused');
        
        // Remove ESC key listener
        document.removeEventListener('keydown', handleZenEscape);
    }
    
    function handleZenEscape(e) {
        if (e.key === 'Escape' && isZenMode) {
            exitZenMode();
        }
    }
})();
</script>
{% endblock content %}